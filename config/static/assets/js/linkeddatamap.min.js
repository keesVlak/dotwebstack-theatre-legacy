var map;var osm=null;var listOfLocations=[];var listOfMarkers=[];var listOfGeoObjects=[];var lastPolygon;var containerURL;var mapChanged=false;var movedItem;var subjectURL;var subjectPolygon=null;var res=[3440.64,1720.32,860.16,430.08,215.04,107.52,53.76,26.88,13.44,6.72,3.36,1.68,0.84,0.42,0.21,0.105];var circleQuotient=0.7;var minEdgeLength=100;var numberRegexp=/^[-+]?([0-9]*\.[0-9]+|[0-9]+)([eE][-+]?[0-9]+)?/;function parse(s){var k=s.split(";"),s=k.pop(),p=(k.shift()||"").split("=").pop();var o=0;function d(u){var t=s.substring(o).match(u);if(!t){return null}else{o+=t[0].length;return t[0]}}function c(t){if(t&&p.match(/\d+/)){t.crs={type:"name",properties:{name:"urn:ogc:def:crs:EPSG::"+p}}}return t}function f(){d(/^\s*/)}function j(){f();var x=0,v=[],t=[v],w=v,u;while(u=d(/^(\()/)||d(/^(\))/)||d(/^(\,)/)||d(numberRegexp)){if(u=="("){t.push(w);w=[];t[t.length-1].push(w);x++}else{if(u==")"){w=t.pop();if(!w){return}x--;if(x===0){break}}else{if(u===","){w=[];t[t.length-1].push(w)}else{if(!isNaN(parseFloat(u))){w.push(parseFloat(u))}else{return null}}}}f()}if(x!==0){return null}return v}function n(){var u=[],t,v;while(v=d(numberRegexp)||d(/^(\,)/)){if(v==","){u.push(t);t=[]}else{if(!t){t=[]}t.push(parseFloat(v))}f()}if(t){u.push(t)}return u.length?u:null}function m(){if(!d(/^(point)/i)){return null}f();if(!d(/^(\()/)){return null}var t=n();if(!t){return null}f();if(!d(/^(\))/)){return null}return{type:"Point",coordinates:t[0]}}function e(){if(!d(/^(circle)/i)){return null}f();if(!d(/^(\()/)){return null}var t=n();if(!t){return null}f();if(!d(/^(\))/)){return null}return{type:"Point",radius:circleQuotient*parseFloat(t[1]),originalradius:t[1],coordinates:t[0]}}function q(){if(!d(/^(multipoint)/i)){return null}f();var t=j();if(!t){return null}f();return{type:"MultiPoint",coordinates:t}}function g(){if(!d(/^(multilinestring)/i)){return null}f();var t=j();if(!t){return null}f();return{type:"MultiLineString",coordinates:t}}function b(){if(!d(/^(linestring)/i)){return null}f();if(!d(/^(\()/)){return null}var t=n();if(!t){return null}if(!d(/^(\))/)){return null}return{type:"LineString",coordinates:t}}function h(){if(!d(/^(polygon)/i)){return null}f();return{type:"Polygon",coordinates:j()}}function r(){if(!d(/^(multipolygon)/i)){return null}f();return{type:"MultiPolygon",coordinates:j()}}function a(){var t=[],u;if(!d(/^(geometrycollection)/i)){return null}f();if(!d(/^(\()/)){return null}while(u=l()){t.push(u);f();d(/^(\,)/);f()}if(!d(/^(\))/)){return null}return{type:"GeometryCollection",geometries:t}}function l(){return m()||e()||b()||h()||q()||g()||r()||a()}return c(l())}function style(a){return{weight:1,className:a.geometry.styleclass}}function highlightFeature(b){var a=b.target;map.doubleClickZoom.disable();map.dragging.disable();if(!(a instanceof L.Marker)){a.setStyle({weight:5});if(!L.Browser.ie&&!L.Browser.opera){a.bringToFront()}}}function resetHighlight(b){var a=b.target;map.doubleClickZoom.enable();map.dragging.enable();if(!(a instanceof L.Marker)){a.setStyle({weight:1})}}function circleMoveStart(a){movedItem=a.target;if(movedItem.edge!=undefined){d3.select(movedItem.edge._path).attr("marker-end","none")}if(movedItem.redge!=undefined){d3.select(movedItem.redge._path).attr("marker-end","none")}map.on("mousemove",circleMove);map.on("mouseup",circleMoveEnd)}function setChangeColors(){if(!mapChanged){if(listOfMarkers.length==0){for(i=0;i<listOfGeoObjects.length;++i){var a=listOfGeoObjects[i].getLayers()[0];if(a.feature.geometry.styleclass!="shidden-object"){listOfGeoObjects[i].setStyle({fillColor:"#000000",color:"#000000"});path=listOfGeoObjects[i].getLayers()[0]._path;path.setAttribute("class","leaflet-interactive")}}}mapChanged=true}if(listOfMarkers.indexOf(movedItem)===-1){movedItem.setStyle({fillColor:"#FF0000",color:"#FF0000"});listOfMarkers.push(movedItem)}}function circleMove(b){movedItem.setLatLng(b.latlng);if(movedItem.label){movedItem.label.setLatLng(movedItem._latlng)}setChangeColors();if(movedItem.edge!=undefined){var a=Array();a.push(b.latlng);a.push(movedItem.edge.getLatLngs()[1]);movedItem.edge.setLatLngs(a)}if(movedItem.redge!=undefined){var a=Array();a.push(movedItem.redge.getLatLngs()[0]);a.push(b.latlng);movedItem.redge.setLatLngs(a)}}function circleMoveEnd(a){map.removeEventListener("mousemove");if(movedItem.edge!=undefined){d3.select(movedItem.edge._path).attr("marker-end","url(#ArrowHead)")}if(movedItem.redge!=undefined){d3.select(movedItem.redge._path).attr("marker-end","url(#ArrowHead)")}}function onEachFeature(b,a){a.on({mouseover:highlightFeature,mouseout:resetHighlight,mousedown:circleMoveStart})}function pointToLayer(a,b){if(a.radius){return L.circleMarker(b,{radius:res[0]*a.radius/res[map.getZoom()]})}else{return L.marker(b)}}function removeArrowheads(b){for(i=0;i<listOfGeoObjects.length;++i){var a=listOfGeoObjects[i].getLayers()[0];if(a instanceof L.CircleMarker){if(a.edge!=undefined){d3.select(a.edge._path).attr("marker-end","none")}if(a.redge!=undefined){d3.select(a.redge._path).attr("marker-end","none")}}}}function resizeCircle(b){for(i=0;i<listOfGeoObjects.length;++i){var a=listOfGeoObjects[i].getLayers()[0];if(a instanceof L.CircleMarker){a.setStyle({radius:res[0]*a.feature.geometry.radius/res[map.getZoom()]});if(a.edge!=undefined){d3.select(a.edge._path).attr("marker-end","url(#ArrowHead)")}if(a.redge!=undefined){d3.select(a.redge._path).attr("marker-end","url(#ArrowHead)")}}}}function addWKT(c,h,m,a,k){var j=parse(h);j.url=a;j.uri=c;j.styleclass=k;var f="";if(a!=""){f+='<a href="'+a+'">'+m+"</a>"}else{f+=m}lastPolygon=L.geoJson(j,{style:style,onEachFeature:onEachFeature,pointToLayer:pointToLayer}).addTo(map).bindPopup(f);if(c===subjectURL){subjectPolygon=lastPolygon}lastPolygon.uri=c;if(lastPolygon.bindLabel2!=undefined){var g=lastPolygon.getLayers()[0];var l=map.latLngToLayerPoint(g._latlng);var e=map.layerPointToContainerPoint(l);var b=document.createElementNS("http://www.w3.org/2000/svg","text");b.setAttribute("x",e.x);b.setAttribute("y",e.y);var d=document.createTextNode("test");b.appendChild(d);g._path.parentNode.appendChild(b)}if(lastPolygon.bindLabel!=undefined){lastPolygon.bindLabel(m,{noHide:true,offset:[0,0]});lastPolygon.showLabel()}listOfGeoObjects.push(lastPolygon)}function addEdge(f,c,e){var b=Array();var g=listOfGeoObjects.filter(function(h){return h.uri==f})[0];var a=listOfGeoObjects.filter(function(h){return h.uri==e})[0];if(g!=undefined&&a!=undefined){b.push(g.getLayers()[0].getLatLng());b.push(a.getLayers()[0].getLatLng());dx=b[0].lat-b[1].lat;dy=b[0].lng-b[1].lng;if(dx*dx+dy*dy>minEdgeLength){var d=L.polyline(b,{className:"edgestyle"}).addTo(map);d3.select(d._path).attr("marker-end","url(#ArrowHead)").attr("stroke","#606060");g.getLayers()[0].edge=d;a.getLayers()[0].redge=d}}}function updateMap(){updateTTL="@prefix geo: <http://www.w3.org/2003/01/geo/wgs84_pos#>. ";for(i=0;i<listOfMarkers.length;++i){updateTTL+="<"+listOfMarkers[i].feature.geometry.uri+'> geo:geometry "CIRCLE('+listOfMarkers[i].getLatLng().lng+" "+listOfMarkers[i].getLatLng().lat+","+listOfMarkers[i].feature.geometry.originalradius+')". '}for(i=0;i<listOfGeoObjects.length;++i){layer=listOfGeoObjects[i].getLayers()[0];if(layer.feature.geometry.styleclass!="shidden-object"){layer._path.setAttribute("class","leaflet-interactive "+layer.feature.geometry.styleclass)}}if(listOfMarkers.length>0){$.post(containerURL,{container:containerURL,content:updateTTL},function(a){alert(a.response)},"json");listOfMarkers=[]}mapChanged=false}function addPoint(a,c,h,d,g,f){var b=L.marker([a,c]).addTo(map);if(f!=""){b.setIcon(L.icon({iconUrl:f}))}var e="";if(d!=""){e+='<a href="'+d+'">'+h;if(g!=""){e+=" ("+g+")"}e+="</a>"}else{e+=h;if(g!=""){e+=" ("+g+")"}}b.bindPopup(e);listOfLocations.push(b)}function printMap(){map.setZoom(1);var c=document.getElementsByClassName("leaflet-image-layer")[0];for(i=0;i<listOfGeoObjects.length;++i){var b=getComputedStyle(listOfGeoObjects[i].getLayers()[0]._path);listOfGeoObjects[i].setStyle({color:b.getPropertyValue("stroke"),fillColor:b.getPropertyValue("fill"),fillOpacity:b.getPropertyValue("fill-opacity")})}var a=document.getElementsByTagName("svg")[0];var e=(new XMLSerializer).serializeToString(a.parentNode);var d=document.getElementById("svgform");d.data.value=e;d.type.value="pdf";d.dimensions.value=c._leaflet_pos.x+"|"+c._leaflet_pos.y+"|"+a._leaflet_pos.x+"|"+a._leaflet_pos.y+"|"+c.width+"|"+c.height+"|"+a.width.baseVal.value+"|"+a.height.baseVal.value;d.imgsrc.value=c.src;d.submit()}function mapClicked(a){map.clicked=map.clicked+1;setTimeout(function(){if(map.clicked==1){var b=document.getElementById("clickform");b.lat.value=a.latlng.lat;b["long"].value=a.latlng.lng;b.zoom.value=map.getZoom();b.submit()}},300)}function mapDblClicked(a){map.clicked=0}function initMap(f,p,k,h,o,b,m,g,n,d,q,j){subjectURL=j;L.Icon.Default.imagePath=f+"/images/";if(o==="image"){map=L.map("map",{minZoom:1,maxZoom:4,center:[d/2,0],zoom:2,crs:L.CRS.Simple});var c=map.unproject([g,q+n],map.getMaxZoom()-1);var e=map.unproject([d+g,n],map.getMaxZoom()-1);var a=new L.LatLngBounds(c,e);osm=new L.imageOverlay(b,a);map.addLayer(osm);map.setMaxBounds(a);L.easyButton('<span class="print"><b>P</b></span>',printMap).addTo(map);if(m!==""){containerURL=m;L.easyButton('<span class="save"><b>S</b></span>',updateMap).addTo(map)}}else{overlay=null;if(o==="brt"){var l=new L.Proj.CRS("EPSG:28992","+proj=sterea +lat_0=52.15616055555555 +lon_0=5.38763888888889 +k=0.9999079 +x_0=155000 +y_0=463000 +ellps=bessel +units=m +towgs84=565.2369,50.0087,465.658,-0.406857330322398,0.350732676542563,-1.8703473836068,4.0812 +no_defs",{resolutions:res,bounds:L.bounds([-285401.92,22598.08],[595401.9199999999,903401.9199999999]),origin:[-285401.92,22598.08]});map=L.map("map",{crs:l,maxZoom:14});osm=new L.TileLayer("http://geodata.nationaalgeoregister.nl/tms/1.0.0/brtachtergrondkaart/{z}/{x}/{y}.png",{minZoom:1,maxZoom:16,tms:true,continuousWorld:true})}else{if(o=="brk"){var l=new L.Proj.CRS("EPSG:28992","+proj=sterea +lat_0=52.15616055555555 +lon_0=5.38763888888889 +k=0.9999079 +x_0=155000 +y_0=463000 +ellps=bessel +units=m +towgs84=565.2369,50.0087,465.658,-0.406857330322398,0.350732676542563,-1.8703473836068,4.0812 +no_defs",{resolutions:res,bounds:L.bounds([-285401.92,22598.08],[595401.9199999999,903401.9199999999]),origin:[-285401.92,22598.08]});map=L.map("map",{crs:l,maxZoom:13});osm=new L.TileLayer("http://geodata.nationaalgeoregister.nl/tms/1.0.0/brtachtergrondkaart/{z}/{x}/{y}.png",{minZoom:1,maxZoom:13,tms:true,continuousWorld:true});overlay=new L.tileLayer.wms("https://geodata.nationaalgeoregister.nl/kadastralekaartv2/wms",{layers:"perceel,perceelnummer",format:"image/png",transparent:true})}else{if(o=="bgt"){var l=new L.Proj.CRS("EPSG:28992","+proj=sterea +lat_0=52.15616055555555 +lon_0=5.38763888888889 +k=0.9999079 +x_0=155000 +y_0=463000 +ellps=bessel +units=m +towgs84=565.2369,50.0087,465.658,-0.406857330322398,0.350732676542563,-1.8703473836068,4.0812 +no_defs",{resolutions:res,bounds:L.bounds([-285401.92,22598.08],[595401.9199999999,903401.9199999999]),origin:[-285401.92,22598.08]});map=L.map("map",{crs:l,minZoom:12,maxZoom:15});osm=new L.TileLayer.WMTS("http://geodata.nationaalgeoregister.nl/tiles/service/wmts",{layer:"bgtpastel",style:"_null",tilematrixSet:"EPSG:28992:16",format:"image/png"})}else{if(o=="none"){map=L.map("map")}else{map=L.map("map");osm=new L.TileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{minZoom:1,maxZoom:18})}}}}map.setView(new L.LatLng(k,h),p);if(osm){map.addLayer(osm);if(overlay){map.addLayer(overlay)}}}map.on("dblclick",mapDblClicked);map.on("zoomstart",removeArrowheads);map.on("zoomend",resizeCircle);map.on("movestart",removeArrowheads);map.on("moveend",resizeCircle);map.invalidateSize()}function addOverlay(c,b,a){if(a){map.addLayer(L.tileLayer.wms(c,{layers:b,format:"image/png",transparent:true}))}else{map.addLayer(L.tileLayer.wms(c,{layers:b,format:"image/jpeg",transparent:false}))}}function showLocations(c,a){d3.select(map.getPanes().overlayPane).selectAll("g").append("marker").attr("id","ArrowHead").attr("viewBox","0 -5 10 10").attr("refX",10).attr("refY",0).attr("markerWidth",6).attr("markerHeight",6).attr("orient","auto").attr("stroke","#909090").attr("fill","none").attr("stroke-width","2px").append("path").attr("d","M0,-5L10,0L0,5");if(listOfGeoObjects.length!=0){var b=subjectPolygon;if(!b){b=listOfGeoObjects[0]}if(c==1&&(b)&&!(b.getLayers()[0] instanceof L.CircleMarker)){map.fitBounds(b.getBounds())}}if(!(lastPolygon)||a=="GeoSelectAppearance"){map.clicked=0;map.on("click",mapClicked);document.getElementById("map").style.cursor="crosshair"}};