var width=$("#graph").width(),height=500;aspect=height/width;var maxNodes=4;var fullScreenFlag=false;var zoom=d3.behavior.zoom().scaleExtent([0.1,10]).on("zoom",zoomed);var svg=d3.select("#graph").append("svg").attr("width","100%").attr("height","500").attr("overflow","hidden").append("g").call(zoom).on("dblclick.zoom",null);var detailBox=d3.select("#graphtitle");var pt=document.getElementsByTagName("svg")[0].createSVGPoint();var propertyBox=d3.select("#propertybox");var infoBox=propertyBox.append("div");infoBox.attr("class","infobox");var propertyNode=null;var infoNode=null;var propertyBoxVisible=false;var rect=svg.append("rect").attr("width","100%").attr("height","100%").attr("class","canvas");var container=svg.append("g");var bugIE=((navigator.appVersion.indexOf("rv:11")!=-1)||(navigator.appVersion.indexOf("MSIE 10")!=-1));container.append("defs").selectAll("marker").data(["end"]).enter().append("marker").attr("id","ArrowHead").attr("viewBox","0 -5 10 10").attr("refX",10).attr("refY",0).attr("markerWidth",6).attr("markerHeight",6).attr("orient","auto").append("path").attr("d","M0,-5L10,0L0,5");var force=d3.layout.force().gravity(0).distance(150).charge(-200).size([width,height]).on("tick",tick);var allLinks=container.selectAll(".link"),allNodes=container.selectAll(".node"),nodeMap={},linkMap={},root={},currentNode=null;d3.json(jsonApiCall+encodeURIComponent(jsonApiSubject),function(a,b){root.nodes=b.nodes;root.nodes.forEach(function(c){nodeMap[c["@id"]]=c});root.links=[];b.links.forEach(function(c){if(linkMap[c.source+c.target]){linkMap[c.source+c.target].label=linkMap[c.source+c.target].label+", "+c.label}else{var d={id:c.source+c.target,source:nodeMap[c.source],target:nodeMap[c.target],label:c.label,uri:c.uri};linkMap[c.source+c.target]=d;root.links.push(d)}});root.nodes[0].x=width/2;root.nodes[0].y=height/2;root.nodes[0].fixed=true;root.nodes[0].expanded=true;updateTitle(root.nodes[0]);root.nodes.forEach(function(c){c.inLinks={};c.outLinks={};c.linkCount=0;c.parentLink;c.elementType="rect"});root.links.forEach(function(c){c.source.outLinks[c.uri]=c.source.outLinks[c.uri]||[];c.source.outLinks[c.uri].push(c);c.source.linkCount++;c.source.parentLink=c;c.target.inLinks[c.uri]=c.target.inLinks[c.uri]||[];c.target.inLinks[c.uri].push(c);c.target.linkCount++;c.target.parentLink=c});createAggregateNodes();update()});function movePropertyBox(){if(propertyBoxVisible&&propertyNode){if(propertyNode.arect){propertyBox.style("display","block");var b=propertyNode.arect.getScreenCTM();if(propertyNode.arect.nodeName==="rect"){pt.x=propertyNode.arect.x.animVal.value+propertyNode.arect.width.animVal.value;pt.y=propertyNode.arect.y.animVal.value}if(propertyNode.arect.nodeName==="circle"){pt.x=propertyNode.arect.cx.animVal.value+propertyNode.arect.r.animVal.value;pt.y=propertyNode.arect.cy.animVal.value-propertyNode.arect.r.animVal.value}var a=pt.matrixTransform(b);var d=a.x-$("#graphcanvas").offset().left+$(window).scrollLeft();var c=a.y-$("#graphcanvas").offset().top+$(window).scrollTop();propertyBox.style("left",d+"px");propertyBox.style("top",c+"px")}}}function mouseoverNode(b){if(!propertyBoxVisible){propertyNode=b;propertyBoxVisible=true;movePropertyBox();if(infoNode!=propertyNode){var a="";infoBox.html(a)}}}function mouseoutNode(b){if(propertyBoxVisible){propertyBoxVisible=false;propertyBox.style("display","none");if(infoNode!=propertyNode){var a="";infoBox.html(a)}}}function mouseoverPropertyBox(){if(!propertyBoxVisible){propertyBox.style("display","block");propertyBoxVisible=true}}function mouseoutPropertyBox(){propertyBox.style("display","none");propertyBoxVisible=false;if(infoNode!=propertyNode){var a="";infoBox.html(a)}}function createAggregateNodes(){root.nodes.forEach(function(a){if(!a.aggregateNode){Object.getOwnPropertyNames(a.outLinks).forEach(function(e){var c=a.outLinks[e];if(c.length>=maxNodes){if(!nodeMap[a["@id"]+c[0].uri]){var b={"@id":a["@id"]+c[0].uri,data:{},label:c[0].label,uri:c[0].uri,elementType:"circle",aggregateNode:true,inbound:false,count:c.length,links:c};root.nodes.push(b);root.links.push({id:a["@id"]+c[0].uri,source:a,target:b,label:c[0].label,uri:c[0].uri});nodeMap[b["@id"]]=b}}});Object.getOwnPropertyNames(a.inLinks).forEach(function(e){var c=a.inLinks[e];if(c.length>=maxNodes){if(!nodeMap[a["@id"]+c[0].uri]){var b={"@id":a["@id"]+c[0].uri,data:{},label:c[0].label,uri:c[0].uri,elementType:"circle",aggregateNode:true,inbound:true,count:c.length,links:c};root.nodes.push(b);root.links.push({id:a["@id"]+c[0].uri,source:b,target:a,label:c[0].label,uri:c[0].uri});nodeMap[b["@id"]]=b}}})}});root.nodes.forEach(function(a){if(a.aggregateNode){a.count=a.links.filter(function(b){return((b.target.linkCount<=1)||(b.source.linkCount<=1))}).length}})}var node_drag=d3.behavior.drag().on("dragstart",dragstart).on("drag",dragmove).on("dragend",dragend);function updateTitle(b){var a='<h3 class="panel-title"><a style="font-size:16px" href="'+uriEndpoint+encodeURIComponent(b["@id"])+'"><span class="glyphicon glyphicon-new-window"/></a> '+b.label;if(!b.expanded){a+=' <a onclick="expand();" class="badge" style="font-size:12px">';if(b.data.count){a+=b.data.count}a+='<span class="glyphicon glyphicon-zoom-in"/></a>'}a+='<span class="glyphicon glyphicon-fullscreen" style="position:absolute;right:10px;margin-top:10px;cursor:pointer" onclick="togglefullscreen()"/>';a+="</h3>";detailBox.html(a)}function togglefullscreen(){if(fullScreenFlag){$("#graphcanvas").css({position:"relative",left:"",top:"",width:"",height:"",zIndex:""})}else{$("#graphcanvas").css({position:"absolute",left:0,top:0,width:$(window).width(),height:$(window).height(),zIndex:1000});d3.select("#graph").select("svg").attr("height",$(window).height()-100)}fullScreenFlag=!fullScreenFlag}function dragstart(a){d3.event.sourceEvent.stopPropagation();force.stop();currentNode=a;updateTitle(a)}function dragmove(a){a.px+=d3.event.dx;a.py+=d3.event.dy;a.x+=d3.event.dx;a.y+=d3.event.dy;tick()}function dragend(a){a.fixed=true;tick();force.resume()}function zoomed(){container.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")}function update(){var b=root.nodes.filter(function(e){return e.aggregateNode?(!e.expanded)&&(e.count>0):((e.linkCount>1)||((e.parentLink.source.outLinks[e.parentLink.uri].length<maxNodes)&&(e.parentLink.target.inLinks[e.parentLink.uri].length<maxNodes)))});var a=root.links;a=root.links.filter(function(e){return e.source.aggregateNode?(!e.source.expanded)&&(e.source.count>0):e.target.aggregateNode?(!e.target.expanded)&&(e.target.count>0):(((e.source.linkCount>1)&&(e.target.linkCount>1))||((e.source.outLinks[e.uri].length<maxNodes)&&(e.target.inLinks[e.uri].length<maxNodes)))});allLinks=allLinks.data(a,function(e){return e.id});allLinks.exit().remove();var d=allLinks.enter().append("g").attr("class",function(e){return"link"+(e.source["class"]?" t"+e.source["class"]:"")+(e.target["class"]?" t"+e.target["class"]:"")});d.append("line").attr("class","border");d.append("line").style("marker-end","url(#ArrowHead)").attr("class","stroke");d.append("text").attr("dx",0).attr("dy",0).attr("text-anchor","middle").attr("class","stroke-text").text(function(e){return e.label});allNodes=allNodes.data(b,function(e){return e["@id"]});allNodes.select("text").text(function(e){return e.aggregateNode?e.count:e.label});allNodes.exit().remove();var c=allNodes.enter().append("g").attr("class",function(e){return(e["class"]?"node t"+e["class"]:"node")}).on("mouseover",mouseoverNode).on("mouseout",mouseoutNode).call(node_drag);c.append("text").attr("dx",0).attr("dy",0).attr("text-anchor","middle").attr("class","node-text").text(function(e){return e.aggregateNode?e.count:e.label}).each(function(e){e.rect=this.getBBox()});c.filter(function(e){return e.elementType==="rect"}).append("rect").attr("x",function(e){return e.rect.x-5}).attr("y",function(e){return e.rect.y-5}).attr("width",function(e){return e.rect.width+10}).attr("height",function(e){return e.rect.height+10}).attr("class",function(e){return(e["class"]?"s"+e["class"]:"default")}).each(function(e){e.arect=this});c.filter(function(e){return e.elementType==="circle"}).append("circle").attr("cx",function(e){return e.rect.x+5}).attr("cy",function(e){return e.rect.y+5}).attr("r",function(e){return 5+e.rect.height/2}).attr("class",function(e){return(e["class"]?"s"+e["class"]:"default")}).each(function(e){e.arect=this});force.nodes(b).links(a).start()}function togglenode(a,c){var b=container.selectAll(".t"+c);b.style("visibility",a?"visible":"hidden")}function clickPropertyBox(){if(propertyNode){dblclick(propertyNode)}}function expandOneItem(b){var a=nodeMap[b];if(a){a.linkCount++}if(propertyNode){if(propertyNode.aggregateNode){propertyNode.count-=1;clickInfoBox()}}update()}function clickInfoBox(){if(propertyNode){infoNode=propertyNode;if(propertyNode.aggregateNode){var b='<table style="background-color:#F0F0F0;">';propertyNode.links.forEach(function(c){if(propertyNode.inbound){if(c.source.linkCount<=1){b+='<tr><td><a onclick="expandOneItem(this.href);return false;" href="'+c.source["@id"]+'">'+c.source.label+"</a></td></tr>"}}else{if(c.target.linkCount<=1){b+='<tr><td><a onclick="expandOneItem(this.href);return false;" href="'+c.target["@id"]+'">'+c.target.label+"</a></td></tr>"}}});b+="</table>";infoBox.html(b)}else{var b="<table>";for(var a in propertyNode.data){b+="<tr><td>"+a+'</td><td class="data">'+propertyNode.data[a]+"</td></tr>"}b+="</table>";infoBox.html(b)}}}function tick(b){if(typeof b!="undefined"){var a=6*b.alpha}allLinks.each(function(i){if(typeof b!="undefined"){i.source.y+=a;i.target.y-=a}var p=Math.abs(i.target.x-i.source.x)+1,o=Math.abs(i.target.y-i.source.y)+1,l=i.target.x<i.source.x?p:-p,k=i.target.y<i.source.y?o:-o,c=i.target.x+(i.source.x<i.target.x?Math.max(i.target.rect.x-5,(i.target.rect.y-5)*p/o):Math.min(i.target.rect.x-5+i.target.rect.width+10,-(i.target.rect.y-5)*p/o)),m=i.target.y+(i.source.y<i.target.y?Math.max(i.target.rect.y-5,(i.target.rect.x-5)*o/p):Math.min(i.target.rect.y-5+i.target.rect.height+10,-(i.target.rect.x-5)*o/p)),e=i.source.x+(i.target.x<i.source.x?Math.max(i.source.rect.x-5,(i.source.rect.y-5)*p/o):Math.min(i.source.rect.x-5+i.source.rect.width+10,-(i.source.rect.y-5)*p/o)),n=i.source.y+(i.target.y<i.source.y?Math.max(i.source.rect.y-5,(i.source.rect.x-5)*o/p):Math.min(i.source.rect.y-5+i.source.rect.height+10,-(i.source.rect.x-5)*o/p));if(i.target.elementType==="circle"){var f=Math.sqrt((l*l)+(k*k)),j=5+i.target.rect.height/2;c=i.target.x+((l*j)/f)+2;m=i.target.y+((k*j)/f)-5}if(i.source.elementType==="circle"){var f=Math.sqrt((l*l)+(k*k)),j=5+i.source.rect.height/2;e=i.source.x-((l*j)/f);n=i.source.y-((k*j)/f)-5}d3.select(this).selectAll("line").attr("x1",e).attr("y1",n).attr("x2",c).attr("y2",m);var h=e+(c-e)*2/3,g=n+(m-n)*2/3;d3.select(this).selectAll("text").attr("x",h).attr("y",g-3).attr("transform","rotate("+Math.atan(k/l)*57+" "+h+" "+g+")");if(bugIE){this.parentNode.insertBefore(this,this)}});allNodes.attr("transform",function(c){return"translate("+c.x+","+c.y+")"});movePropertyBox()}function expand(){if(currentNode){dblclick(currentNode)}}function dblclick(a){a.fixed=a.expanded?!a.fixed:a.fixed;if(!a.aggregateNode){if(!a.expanded){d3.json(jsonApiCall+encodeURIComponent(a["@id"]),function(c,d){var b=d.nodes.filter(function(e){return !nodeMap[e["@id"]]});b.forEach(function(e){root.nodes.push(e);nodeMap[e["@id"]]=e;e.x=a.x;e.y=a.y;e.inLinks={};e.outLinks={};e.linkCount=0;e.parentLink;e.elementType="rect"});d.links.forEach(function(e){if(linkMap[e.source+e.target]){var g=linkMap[e.source+e.target];if((g.uri!=e.uri)&&(g.label!=e.label)){g.label=g.label+", "+e.label}}else{var f={id:e.source+e.target,source:nodeMap[e.source],target:nodeMap[e.target],label:e.label,uri:e.uri};root.links.push(f);linkMap[e.source+e.target]=f;f.source.outLinks[f.uri]=f.source.outLinks[f.uri]||[];f.source.outLinks[f.uri].push(f);f.source.linkCount++;f.source.parentLink=f;f.target.inLinks[f.uri]=f.target.inLinks[f.uri]||[];f.target.inLinks[f.uri].push(f);f.target.linkCount++;f.target.parentLink=f}});a.expanded=true;updateTitle(a);createAggregateNodes();update()})}}else{a.expanded=true;a.links.forEach(function(b){b.target.linkCount++;b.source.linkCount++});update()}};